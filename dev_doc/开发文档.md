# Manga Translator 开发文档

## 1. 文档目的与范围
- 本文档面向项目临时开发者。
- 文档目标是让开发者迅速了解项目结构，迅速上手开发。
- 文档应及时更新。

---

## 2. 开发环境与构建

### 2.1 推荐环境
- 操作系统：Windows + WSL2 (Ubuntu) 或原生 Linux。
- JDK：OpenJDK 17.0.17。
- Kotlin：2.0.0+。
- Gradle：8.11.1+（使用项目自带 Wrapper）。
- Android SDK：
  - `platforms;android-35`
  - `build-tools;35.0.0`
  - `platform-tools;36.0.2+`

### 2.2 环境变量
```bash
export ANDROID_HOME=/home/jed/Android
export PATH=$PATH:$ANDROID_HOME/platform-tools
```

### 2.3 SDK 安装与检查
```bash
sdkmanager "platforms;android-35" "build-tools;35.0.0" "platform-tools"
java -version
sdkmanager --list
```

### 2.4 常用构建命令
```bash
./gradlew tasks
./gradlew :app:assembleDebug
./gradlew :app:assembleRelease
./gradlew :app:lint
```

### 2.5 构建产物路径
- Debug APK：`app/build/outputs/apk/debug/`
- Release APK：`app/build/outputs/apk/release/`
- Lint 报告：`app/build/reports/`

### 2.6 依赖仓库说明
- 单模块项目，仓库源统一在 `settings.gradle.kts`。
- 如 Google Maven TLS 不可用，可使用已配置镜像：
  - `https://maven.aliyun.com/repository/google`
  - `https://maven.aliyun.com/repository/central`
  - `https://maven.aliyun.com/repository/gradle-plugin`

---

## 3. 仓库结构与模块边界

### 3.1 根目录
```text
.
├── app/
├── assets/
├── gradle/
├── build.gradle.kts
├── settings.gradle.kts
├── gradle.properties
├── gradlew
├── gradlew.bat
├── update.json
├── README.md
├── 开发文档.md
└── 改进计划.md
```

### 3.2 App 模块分层（`app/src/main/java/com/manga/translate`）
- 入口与导航：
  - `MangaTranslateApp.kt`
  - `MainActivity.kt`
  - `MainPagerAdapter.kt`
- 页面容器层：
  - `LibraryFragment.kt`
  - `ReadingFragment.kt`
  - `SettingsFragment.kt`
- Library 子模块：
  - `LibraryImportExportCoordinator.kt`
  - `FolderTranslationCoordinator.kt`
  - `FolderEmbedCoordinator.kt`
  - `LibrarySelectionController.kt`
  - `LibraryPreferencesGateway.kt`
  - `LibraryDialogs.kt`
  - `LibraryRepository.kt`
  - `LibraryUiCallbacks.kt`
- Reading 子模块：
  - `ReadingImageTransformController.kt`
  - `ReadingEmptyBubbleCoordinator.kt`
  - `ReadingSessionViewModel.kt`
  - `FloatingTranslationView.kt`
  - `ReadingDisplayMode.kt`
  - `BubbleRenderer.kt`
- 翻译与 OCR：
  - `TranslationPipeline.kt`
  - `BubbleDetector.kt`
  - `TextDetector.kt`
  - `TextMaskDetector.kt`
  - `OcrEngine.kt`
  - `MangaOcr.kt`
  - `EnglishOcr.kt`
  - `EnglishLineDetector.kt`
  - `TranslationLanguage.kt`
  - `OcrTextHelpers.kt`
  - `MiganInpainter.kt`
  - `EmbeddedTextRenderer.kt`
- 本地文件结果存储（JSON）：
  - `TranslationStore.kt`
  - `OcrStore.kt`
  - `GlossaryStore.kt`
  - `ExtractStateStore.kt`
  - `EmbeddedStateStore.kt`
- 偏好与运行状态存储（SharedPreferences）：
  - `SettingsStore.kt`
  - `ReadingProgressStore.kt`
  - `CrashStateStore.kt`
  - `UpdateIgnoreStore.kt`
- 网络与外部服务集成：
  - `LlmClient.kt`
  - `UpdateChecker.kt`
- 配置枚举与偏好值映射：
  - `LinkSource.kt`
  - `ThemeMode.kt`
- 运行保障与日志：
  - `AppLogger.kt`
  - `TranslationKeepAliveService.kt`

### 3.3 资源目录
- `app/src/main/res/`：UI 布局与资源。
- `app/src/main/assets/`：应用内静态资源。
- 根目录 `assets/`：模型与提示词资源；通过 `app/build.gradle.kts` 的 `sourceSets` 合并到 app assets。
- 关键配置片段：
```kotlin
sourceSets["main"].assets.srcDirs("src/main/assets", "../assets")
```

### 3.4 改动定位速查
- 改翻译流程：`TranslationPipeline.kt`、`FolderTranslationCoordinator.kt`、`LlmClient.kt`。
- 改嵌字流程：`FolderEmbedCoordinator.kt`、`TextMaskDetector.kt`、`MiganInpainter.kt`、`EmbeddedTextRenderer.kt`。
- 改阅读交互：`ReadingFragment.kt`、`ReadingImageTransformController.kt`、`FloatingTranslationView.kt`。
- 改库页导入导出：`LibraryImportExportCoordinator.kt`、`LibraryRepository.kt`。
- 改设置项：`SettingsFragment.kt`、`SettingsStore.kt`。
- 改更新逻辑：`UpdateChecker.kt`、`MainActivity.kt`、`update.json`。

### 3.5 详细文件清单
- `AndroidManifest.xml`：权限、入口 Activity、`FileProvider`、前台服务声明。
- 主要布局：
  - `layout/activity_main.xml`：顶部 Tab + 内容容器。
  - `layout/fragment_library.xml`：漫画库与文件夹详情。
  - `layout/fragment_reading.xml`：阅读页图片与翻译覆盖层。
  - `layout/fragment_settings.xml`：设置页表单。
  - `layout/item_folder.xml`、`layout/item_folder_image.xml`：列表项布局。
  - `layout/dialog_update.xml`、`layout/dialog_llm_params.xml`、`layout/dialog_bubble_actions.xml`：更新与参数配置相关对话框。
- 主要资源：
  - `drawable/ic_check.xml`：编辑确认按钮图标。
  - `drawable/ic_launcher_monochrome.xml`：启动图标单色版本。
  - `mipmap-anydpi-v26/ic_launcher.xml`：自适应启动图标入口。
  - `xml/file_paths.xml`：`FileProvider` 路径。
  - `values/strings.xml`：文案。
  - `values/colors.xml`：颜色。
  - `values/themes.xml`、`values-night/themes.xml`：主题。
- 数据模型/适配器：
  - `LibraryModels.kt`：库页列表数据结构。
  - `TranslationModels.kt`：翻译结果数据结构。
  - `LibraryFolderAdapter.kt`、`FolderImageAdapter.kt`：列表绑定与交互。

---

## 4. 核心业务流程

### 4.1 漫画库流程（Library）
- 支持新建文件夹、批量导入图片、EhViewer 导入、CBZ 导入、多选删除/重译。
- 主页面左下角入口顺序：`使用教程` → `从 CBZ 导入` → `从 EhViewer 导入`。
- 从 CBZ 导入流程：
  - 通过系统文件选择器选择单个 CBZ。
  - 以 CBZ 文件名自动新建漫画文件夹（重名自动追加 `_1/_2...`）。
  - 解包时仅导入图片文件（`jpg/jpeg/png/webp`），空包或无图片会回滚并提示失败。
- 文件夹详情可设置翻译语言（按文件夹独立保存）：
  - `JA_TO_ZH`（默认）
  - `EN_TO_ZH`
- 文件夹嵌字操作：
  - `一键嵌字`：执行增量嵌字，仅处理“已翻译且尚未嵌字”的图片，产物写入 `.embedded/`。
  - `取消嵌字`：删除 `.embedded/` 与 `.embedded-state.json` 标记，恢复原图阅读流。
- 文件夹图片点击后进入阅读页并定位到对应页。
- 库页通过 `ReadingSessionViewModel` 在页面间共享阅读会话（当前文件夹、图片列表、起始页索引）。
- 主界面为三标签页：漫画库 / 阅读 / 设置；阅读页禁用 `ViewPager2` 左右滑动切页。
- 库页采用“`LibraryFragment` 容器 + 委托模块”拆分：导入导出、翻译流程、多选控制、偏好访问、对话框分别独立文件。

### 4.2 阅读与气泡编辑流程
- 阅读页按文件名顺序浏览，支持左右点击或滑动翻页。
- 阅读位置按文件夹持久化并在下次进入时恢复。
- 编辑模式：
  - 右上角“编辑”按钮切换编辑态（编辑中显示绿色对勾）。
  - 编辑态禁用翻页点击与滑动切页，避免误操作。
  - 拖动气泡（限制在图片区域内）
  - 修改文本
  - 右上角红叉删除气泡
  - 新增气泡并调整尺寸（宽高独立调节，50%–500%，并限制在图片边界内）
- 新增气泡入口为右上角“+”，默认居中并按图片尺寸估算初始宽高。
- 退出编辑时会保存变更到翻译 JSON。
- 从编辑态切回浏览态时，会触发空白气泡自动翻译流程。
- 阅读页采用“`ReadingFragment` 容器 + 委托模块”拆分：矩阵/手势控制与空白气泡自动翻译分别独立。
- 若文件夹已嵌字且图集完整，阅读页会加载 `.embedded/` 图集并隐藏气泡编辑按钮。
- 若存在任意未嵌字图片（例如新增图片尚未嵌字），点击阅读会强制使用气泡模式（未嵌字图）阅读；仅当全部图片均有对应嵌字图时才进入嵌字阅读。

### 4.3 空白气泡自动翻译流程
- 编辑框文本留空时，界面提示“留空将自动识别”。
- 空白气泡在退出编辑模式后触发 OCR。
- OCR 结果长度 `<= 2` 的气泡自动删除。
- 其余文本批量交给 LLM 翻译并回写。
- LLM 不可用或失败时回退为 OCR 原文。
- 若返回 `glossary_used`，会合并入 `glossary.json`。

### 4.4 翻译主流程
- 标准模式：气泡检测 → OCR → 逐气泡 LLM 翻译 → 生成 `*.json`。
- 全文速译：
  - OCR 全页文本
  - 用 `llm_prompts_abstract.json` 抽取译名（补缺不覆盖）
  - 用 `llm_prompts_FullTrans.json` 执行 `<b>` 段落级翻译
- 并发策略：
  - 标准模式按图片顺序串行
  - 全文速译按设置页“最大并发”执行
- `.extract-state.json` 用于记录译名抽取进度，避免重复抽取。
- OCR/气泡检测在本地 ONNX 推理；翻译与模型列表请求依赖网络和 OpenAI 兼容接口。
- LLM 返回格式异常时会弹窗提示并标记失败。

### 4.5 OCR 语言与检测策略
- 日文：`MangaOcr`（encoder-decoder）。
- 英文：`EnglishOcr`（PP-OCRv5 + CTC）。
- 英文额外行检测：`EnglishLineDetector`（PP-OCRv3 det）。
- 文本补检：`TextDetector`（`ysgyolo_1.2_OS1.0.onnx`）在气泡检测后补充遗漏文本区域。

### 4.6 导出漫画流程
- 文件夹详情页“导出漫画”按钮位于“批量上传图片”按钮右侧。
- 点击“导出漫画”后先弹出“导出参数”对话框：
  - 导出线程数（范围 `1~16`，会持久化）
  - `导出为 CBZ` 开关（会持久化）
  - `导出嵌入图片` 开关（默认开启；当当前文件夹没有完整嵌字图集时灰白锁定不可选）
  - 导出根目录提示（便于用户查找导出文件）
- `导出嵌入图片` 选项规则：
  - 开启：优先导出 `<folder>/.embedded/` 中与原图同名且完整对应的图片。
  - 关闭：按原图导出流程执行。
  - 兜底：若勾选开启但运行时发现嵌字图不完整，会自动回退到原图导出。
- 普通导出（未勾选 CBZ）逐张处理：
  - 有气泡文本：渲染后导出
  - 无气泡文本：原图导出
- Android 10+：
  - 首次使用 SAF 选择目录并持久化权限
  - 推荐目录：`Documents/manga-translator`
  - 后续复用同目录
  - 导出子目录写入 `.nomedia`
- Android 9 及以下：写入 `Documents/manga-translate/<文件夹名>` 并创建 `.nomedia`。
- 普通导出使用用户设置线程数并发渲染/写入，显示前台通知进度。
- CBZ 导出流程：
  - 先按导出线程数并发渲染并写入临时文件；
  - 再单线程按顺序打包为单个 `*.cbz`；
  - Android 10+ 输出到导出根目录；Android 9 及以下输出到 `Documents/manga-translate/` 根目录。
- 导出期间启动前台常驻服务保持后台运行。
- 权限策略：
  - Android 10+：首次导出请求并持久化目录权限。
  - Android 9 及以下：导出前动态申请 `WRITE_EXTERNAL_STORAGE`。

### 4.7 更新检测流程
- 启动时读取远端 `update.json`（GitHub 失败后回退 Gitee）。
- 设置页“查看更新”可手动触发检测（超时 30 秒）。
- 更新弹窗由 `MainActivity.kt` 负责显示与下载。
- 下载链接会按设置页“链接来源”（GitHub/Gitee）自动重写为对应站点。
- 从“关于软件 → 查看更新”进入时，不显示“忽略此版本”按钮。
- 若手动检查无新版本，弹窗标题显示“暂无新版本”；历史版本 `releasedAt` 会显示在版本号旁。
- `UpdateChecker.kt` 职责：按顺序请求多个更新源（当前为 GitHub → Gitee），仅当 `versionName` 与 `apkUrl` 有效时返回 `UpdateInfo`，并解析 `history` 为结构化列表。
- `UpdateIgnoreStore.kt` 职责：持久化“忽略版本号”（`ignored_version_code`），用于决定某个 `versionCode` 是否跳过提醒。

### 4.8 一键嵌字流程
- 入口：文件夹详情页 `一键嵌字`。
- 点击后先弹出“嵌字参数”对话框，可设置嵌字线程数（范围 `1~16`，会持久化）。
- 增量策略：仅处理“已翻译且尚未嵌字”的图片；未翻译图片会跳过，后续翻译完成后可再次增量嵌字。
- 处理管线：
  - 读取翻译气泡坐标与译文。
  - 在气泡区域内调用 `TextMaskDetector`（`ysgyolo_1.2_OS1.0.onnx`）生成文字蒙版。
  - 蒙版会做气泡外扩与多轮膨胀，并在 512 缩放前做额外扩张，降低细字残留。
  - `source=bubble_detector` 的气泡：不再调用 `MiganInpainter`，而是将对应 OCR 蒙版适度扩张后直接纯白覆盖（用于漫画对白气泡快速抹字）。
  - 周边背景若判定为“近白且均匀”，对应字符区域直接白色覆盖，不走模型抹除。
  - 其余来源（`text_detector` / `manual` / `unknown`）仍走原流程，必要时调用抹除模型。
  - 其余区域调用 `MiganInpainter`（`migan_512.onnx`）抹除。
  - 调用 `EmbeddedTextRenderer` 按原气泡坐标绘制译文；每个字符单独绘制贴合白底，提升可读性。
  - 输出同名图片到 `<folder>/.embedded/`。
- 并发与保活：
  - 使用用户设置线程数并发执行嵌字 worker。
  - 任务期间复用前台通知与保活服务，显示嵌字进度并降低后台被回收风险。
- 完成与回滚：
  - 仅当文件夹内全部原图都存在对应嵌字图时，写入 `<folder>/.embedded-state.json`。
  - 任意图片失败会停止当前任务，保留已完成嵌字结果，便于后续继续增量处理。

### 4.9 取消嵌字流程
- 入口：文件夹详情页 `取消嵌字`。
- 行为：删除 `<folder>/.embedded/` 和 `<folder>/.embedded-state.json`。
- 结果：阅读恢复原图，并重新显示气泡编辑能力。

### 4.10 设置页与运行时保障
- 设置页支持 OpenAI 兼容 API URL / Key / 模型名配置，支持模型列表拉取。
- 模型名支持英文逗号分隔多模型分流，按填写项轮询调用；重复项即权重（示例：`A,A,B` 表示约 2/3 请求使用 A，1/3 请求使用 B）。
- 表单在页面 `onPause()` 时自动持久化（切换标签页即保存）。
- AI 参数弹窗确认按钮使用系统默认“确定”（`android.R.string.ok`）。
- 设置页支持最大并发配置（范围 `1~50`，保存时自动归一化）、竖排/横排显示切换、日志查看与分享、链接来源（GitHub/Gitee）切换。
- “分享日志”弹窗支持两类分享：
  - 选择单个日志文件直接分享。
  - 点击“分享错误日志”后，自动筛选包含错误条目的日志并打包为 zip 分享。
- 翻译任务期间使用前台服务常驻通知，并在 Android 13+ 申请通知权限。
- 应用启动阶段会处理崩溃标记并提示查看日志，便于故障追踪。
- `SettingsStore.kt` 职责：统一管理设置项读写与边界归一化（如最大并发 `1~50`、API 超时 `30~1200s`）、主题/阅读模式/链接来源枚举映射，以及 LLM 参数的可空语义（空值表示不下发该参数）。
- `AppLogger.kt` 职责：按会话写入日志文件、限制单文件大小并轮转、清理历史日志（最多 15 个）、筛选错误日志并打包 zip 供分享。
- `TranslationKeepAliveService.kt` 职责：翻译/导出/嵌字长任务期间维持前台服务通知并持有 `PARTIAL_WAKE_LOCK`（1 小时超时），支持状态与进度更新，降低后台被系统回收风险。

### 4.11 入口初始化与主导航职责
- `MangaTranslateApp` 启动时负责初始化日志系统、加载主题模式，并注册全局未捕获异常处理器（崩溃时写入日志并标记崩溃状态）。
- `MainActivity` 为主导航宿主：绑定 `TabLayout + ViewPager2`，统一管理三页入口（漫画库/阅读/设置）。
- `MainPagerAdapter` 维护固定三标签索引常量：`LIBRARY_INDEX = 0`、`READING_INDEX = 1`、`SETTINGS_INDEX = 2`。
- `MainActivity` 启动职责还包括：首次启动检查更新（进程内仅一次）、弹出上次崩溃提示、Android 13+ 通知权限申请。

---

## 5. 数据存储与配置约定

### 5.1 目录与文件
- 漫画库目录：`getExternalFilesDir()/manga_library/`。
- 翻译结果：图片同名 `*.json`。
- OCR 缓存：`*.ocr.json`（翻译后清理）。
- 译名表：`glossary.json`（按文件夹）。
- 译名抽取状态：`.extract-state.json`。
- 嵌字图集：`.embedded/`（文件名与原图一致）。
- 嵌字标记：`.embedded-state.json`。
- 对应存储职责：
  - `TranslationStore.kt`：读写 `*.json`，字段包含图片尺寸与 `bubbles[]`（`id`、`left/top/right/bottom`、`text`、`source`）。
  - `OcrStore.kt`：读写 `*.ocr.json`，结构与翻译结果类似，也包含 `source`（内容为 OCR 原文缓存）。
  - `source` 取值约定：`bubble_detector`（气泡模型）、`text_detector`（文本补检）、`manual`（手动新增）、`unknown`（旧格式或未知来源）。
  - 兼容性：旧 JSON 无 `source` 时按 `unknown` 处理，不影响历史数据读取。
  - `GlossaryStore.kt`：读写 `glossary.json`，仅保留“键和值都非空白”的词条。
  - `ExtractStateStore.kt`：读写 `.extract-state.json`（字符串数组），记录已完成译名抽取的图片名，避免重复抽取。
  - `EmbeddedStateStore.kt`：读写 `.embedded-state.json`，并校验 `.embedded/` 图集有效性。

### 5.2 SharedPreferences 键
- 翻译语言：`translation_language_<文件夹绝对路径>`。
- 链接来源：`link_source`，值为 `gitee`（默认）或 `github`。
- 其他：阅读进度、全文速译开关、EhViewer 权限 URI、忽略更新版本号、并发设置等。
- 对应状态职责：
  - `SettingsStore.kt`：集中管理 API 配置、模型名、版式方向、日志开关、并发/超时、主题、阅读模式、链接来源、LLM 参数等键。
  - `ReadingProgressStore.kt`：以“文件夹绝对路径”为 key 存储当前阅读页索引。
  - `CrashStateStore.kt`：维护 `crashed_last_run` 标记（启动时读取，正常启动后清理）。
  - `UpdateIgnoreStore.kt`：维护 `ignored_version_code`，用于忽略指定新版本提示。

### 5.3 日志约定
- 日志目录优先：`/Android/data/<package>/log/`。
- 退化目录：`files/logs/`。
- 单行格式：`[级别][模块] 时间戳 消息`。
- 级别：
  - `I`：普通日志。
  - `E`：错误日志（含异常时自动标记）。
- 示例：`[I][Settings] 2026-01-15 11:58:31.134 View current log`。
- 错误日志筛选规则：
  - 优先匹配 `"[E]"` 前缀。
  - 兼容历史日志中的 `Exception:` 标记。

### 5.4 `update.json` 约定
- 顶层最新版本必填字段：
  - `versionCode`
  - `versionName`
  - `apkUrl`
  - `changelog`
- `history` 为可选数组。
- `history` 建议字段：
  - `versionName`
  - `changelog`
  - `releasedAt`（可选，示例：`2026-01-19`）
- `history` 项不记录 `versionCode`，避免与“当前最新版本”版本判断逻辑耦合。

### 5.5 Prompt 与接口协议
- 请求接口：OpenAI 兼容 `POST /v1/chat/completions`。
- Prompt 文件：
  - `assets/llm_prompts.json`
  - `assets/llm_prompts_abstract.json`
  - `assets/llm_prompts_FullTrans.json`
- Prompt 字段：
  - `systemPrompt`
  - `exampleMessages`
  - `userPromptPrefix`
- 模型返回 JSON 至少包含：
  - `translation`
  - `glossary_used`
- 用户内容（拼接在 `userPromptPrefix` 后）示例：
```json
{
  "text": "待翻译文本或全文速译的 <b>...</b> 段落串",
  "glossary": {
    "リリー": "莉莉",
    "用语": "固定译名"
  }
}
```
- 模型响应示例：
```json
{
  "translation": "翻译结果文本",
  "glossary_used": {
    "日文词语": "固定译名"
  }
}
```
- `LlmClient.kt` 关键职责：
  - 自动规范化接口地址：将用户填写的 API 基地址拼成 `/v1/chat/completions` 与 `/v1/models`。
  - 使用设置页参数构建请求：模型名 + Prompt 模板 + 可选采样参数。
  - 支持模型输入/输出日志开关（调试用途）。
  - 网络请求失败自动重试（最多 3 次），最终抛出结构化错误码（如 `HTTP xxx`、`INVALID_RESPONSE`、`NETWORK_ERROR`）。
  - 解析模型返回 JSON，至少要求 `translation` 非空；若返回 `glossary_used` 则交由上层流程合并词表。

### 5.6 Assets 资源要求
- 提示词与 tokenizer 相关文件需存在于 assets，例如：
  - `llm_prompts.json`
  - `llm_prompts_abstract.json`
  - `llm_prompts_FullTrans.json`
  - `tokenizer.json`
  - `tokenizer_config.json`
  - `special_tokens_map.json`
  - `config.json`
  - `preprocessor_config.json`
  - `generation_config.json`
  - `font.ttf`
- 模型文件名需与代码约定一致：
  - `comic-speech-bubble-detector.onnx`
  - `encoder_model.onnx`
  - `decoder_model.onnx`
  - `en_PP-OCRv5_rec_mobile_infer.onnx`
  - `ysgyolo_1.2_OS1.0.onnx`
  - `Multilingual_PP-OCRv3_det_infer.onnx`
  - `migan_512.onnx`
  - `migan_512.onnx.data`（MIGAN 外部数据文件，需与 onnx 同目录）

---

## 6. Gradle 与版本基线

### 6.1 当前构建基线
- Android Gradle Plugin：8.9.2。
- Kotlin Plugin：2.0.0。
- `app/build.gradle.kts`：
  - `compileSdk = 35`
  - `targetSdk = 35`
  - `minSdk = 24`
  - `buildFeatures { viewBinding = true }`

### 6.2 依赖项
- `androidx.core:core-ktx:1.13.1`
- `androidx.appcompat:appcompat:1.7.0`
- `com.google.android.material:material:1.12.0`
- `androidx.constraintlayout:constraintlayout:2.1.4`
- `androidx.activity:activity-ktx:1.9.2`
- `androidx.fragment:fragment-ktx:1.7.1`
- `androidx.lifecycle:lifecycle-runtime-ktx:2.8.7`
- `androidx.lifecycle:lifecycle-viewmodel-ktx:2.8.7`
- `androidx.recyclerview:recyclerview:1.3.2`
- `androidx.viewpager2:viewpager2:1.1.0`
- `org.jetbrains.kotlinx:kotlinx-coroutines-android:1.9.0`
- `com.microsoft.onnxruntime:onnxruntime-android:1.19.2`

---

## 7. 发布流程

### 7.1 版本号同步
发版前必须同步以下三处版本号：
- `app/src/main/java/com/manga/translate/VersionInfo.kt`：`VERSION_CODE`、`VERSION_NAME`。
- `app/build.gradle.kts`：`versionCode`、`versionName`。
- `update.json`：`versionCode`、`versionName`、`apkUrl`。

### 7.2 发版命令
```bash
./gradlew :app:assembleRelease
```

### 7.3 发版检查清单
- 版本号三处一致。
- `update.json` 字段完整且可访问。
- 关键路径回归通过：导入、翻译、阅读、导出、更新检测。
- 若启用嵌字功能，需补充回归：一键嵌字成功、阅读切换嵌字图、取消嵌字回滚。
- Lint 无新增高风险问题。

---

## 8. 已知限制与常见排查

### 8.1 已知限制
- 日文 OCR 当前未引入更复杂的置信度筛选与后处理。
- 译名抽取策略为“只补充缺失词条，不覆盖已有词条”。
- LLM 返回格式异常会导致该条翻译失败并提示。

### 8.2 常见问题排查
- 依赖下载失败：优先检查 `settings.gradle.kts` 仓库源与网络连通性。
- 更新不生效：先核对第 7.1 节三处版本号与 `update.json` 内容。
- 导出失败：检查 SAF 目录权限或 Android 9 及以下存储权限。
- 翻译异常：检查 API URL/Key/模型名、网络状态与 Prompt 文件完整性。

### 8.3 开发规范建议
- 所有构建操作统一使用 `./gradlew`。
- 不在根 `build.gradle.kts` 重复声明仓库，避免和 `settings.gradle.kts` 冲突。
- 新增依赖优先选择稳定版本，并同步更新本文件第 6 章。
- 新增资源或模型文件时，遵循第 5.6 节命名与目录约定。

---

## 9. 文档维护规范
- 新增模块、流程或关键配置时，必须同步更新本文件对应章节。
- 同一信息只在一个章节维护，其他章节使用“引用/跳转”方式避免重复。
- 文档改动建议与代码改动在同一 PR 提交，避免文档滞后。

---

## 10. 近期变更记录（2026-02）

### 10.1 更新弹窗交互补充
- 更新弹窗新增“打开项目页面”按钮，便于用户直接跳转到项目主页。
- 更新下载失败（含 `DownloadManager` 不可用或入队异常）时，会提示“可手动打开项目页面下载更新”。
- 相关代码：`MainActivity.kt`、`values/strings.xml`。

### 10.2 全文速译预处理进度可视化
- 在全文速译预处理阶段新增分阶段进度展示，并复用原有进度接口（库页状态 + 前台通知进度）。
- 预处理阶段划分：
  - `预处理 OCR`
  - `预处理 译名提取`
- OCR 阶段按图片逐张显示进度，并在右侧状态显示当前图片名。
- 相关代码：`FolderTranslationCoordinator.kt`、`values/strings.xml`。

### 10.3 分享日志排序优化
- “分享日志”文件列表改为“最新日志在上方”（按日志文件名倒序）。
- 崩溃后“分享崩溃日志”默认取到最新日志文件。
- 相关代码：`AppLogger.kt`。

### 10.4 strings 资源按功能分区
- `app/src/main/res/values/strings.xml` 已按功能模块重排并添加分区注释，便于维护与检索。
- 本次仅调整顺序与注释，不改动资源 key 与文案语义。
